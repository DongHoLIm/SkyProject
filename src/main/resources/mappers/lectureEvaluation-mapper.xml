<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="LectureEvaluation">
	<resultMap type="com.kh.finalProject.lectureEvaluation.model.vo.LectureEvaluation" id="lectureEvaluationResultSet">
		<id property="lectureNo" column="LECTURE_NO"/>
		<result property="doneCode" column="DONE_CODE"/>
		<result property="allCount" column="ALL_COUNT"/>
		<result property="memberCount" column="MEMBER_COUNT"/>
		<result property="doneStatus" column="DONE_STATUS"/>
		<result property="openStatus" column="OPEN_STATUS"/>
		<result property="evalCode" column="EVAL_CODE"/>
		<result property="subName" column="SUB_NAME"/>
		<result property="pdeptName" column="PDEPT_NAME"/>
		<result property="professorName" column="PROFESSOR_NAME"/>
		<result property="answer1" column="ANSWER1"/>
		<result property="answer2" column="ANSWER2"/>
		<result property="answer3" column="ANSWER3"/>
		<result property="answer4" column="ANSWER4"/>
		<result property="answer5" column="ANSWER5"/>
		<result property="totalCount" column="TOTAL_COUNT"/>
		<result property="avgCount" column="AVG_COUNT"/>
		<result property="openSubCode" column="OPENSUB_CODE"/>
	</resultMap>
	
	
	<select id="LectureEvalOpenListCount" resultType="_int">
		SELECT COUNT(DISTINCT O.OPENSUB_CODE)
		FROM CLASS_MANAGEMENT C
		JOIN SUBAPPLY_DONE D ON(C.DONE_CODE = D.DONE_CODE)
		JOIN SUBJECT_APPLY A ON(A.SUBAPPLY_CODE = D.SUBAPPLY_CODE)
		JOIN OPEN_SUBJECT O ON(A.OPENSUB_CODE = O.OPENSUB_CODE)
		JOIN SUBJECT J ON(O.OPENSUB_CODE = J.SUB_CODE)
		JOIN PROFESSOR P ON(O.PROFESSOR_NO = P.PROFESSOR_NO)
		JOIN SDEPARTMENT E ON(P.PDEPT_CODE = E.SDEPT_CODE)
		JOIN GRADE G ON(G.CLASS_CODE = C.CLASS_CODE)
		JOIN MEMBER M ON(P.PROFESSOR_NO = M.MEMBER_ID)
		WHERE G.MIDDLE_SCORE IS NOT NULL
		AND G.FINAL_SCORE IS NOT NULL
		AND G.WORK_SCORE IS NOT NULL
		AND G.ATTENDANCE_SCORE IS NOT NULL
	</select>
	
	<select id="LectureEvalOpenList" resultMap="lectureEvaluationResultSet">
		SELECT O.OPENSUB_CODE, J.SUB_NAME, O.STUDENT_COUNT AS ALL_COUNT,
		       M.MEMBER_KNAME AS PROFESSOR_NAME, E.SDEPT_NAME AS PDEPT_NAME
		FROM CLASS_MANAGEMENT C
		JOIN SUBAPPLY_DONE D ON(C.DONE_CODE = D.DONE_CODE)
		JOIN SUBJECT_APPLY A ON(A.SUBAPPLY_CODE = D.SUBAPPLY_CODE)
		JOIN OPEN_SUBJECT O ON(A.OPENSUB_CODE = O.OPENSUB_CODE)
		JOIN SUBJECT J ON(O.OPENSUB_CODE = J.SUB_CODE)
		JOIN PROFESSOR P ON(O.PROFESSOR_NO = P.PROFESSOR_NO)
		JOIN SDEPARTMENT E ON(P.PDEPT_CODE = E.SDEPT_CODE)
		JOIN GRADE G ON(G.CLASS_CODE = C.CLASS_CODE)
		JOIN MEMBER M ON(P.PROFESSOR_NO = M.MEMBER_ID)
		WHERE G.MIDDLE_SCORE IS NOT NULL
		AND G.FINAL_SCORE IS NOT NULL
		AND G.WORK_SCORE IS NOT NULL
		AND G.ATTENDANCE_SCORE IS NOT NULL
		GROUP BY O.OPENSUB_CODE, J.SUB_CODE, J.SUB_NAME, O.OPEN_YEAR, O.OPEN_SEMESTER, O.STUDENT_COUNT, O.PROFESSOR_NO,
		         M.MEMBER_KNAME, E.SDEPT_NAME
		ORDER BY O.OPENSUB_CODE ASC
	</select>
	
	<insert id="em_LectureEvaluationInsert">
		INSERT INTO EVAL_MANAGEMENT
		VALUES('EV'||SEQ_EVALMANAGEMENT.NEXTVAL, #{openSubCode}, #{allCount}, 0, DEFAULT)
	</insert>
	
	<select id="LectureEvalOpenListCount2" resultType="_int">
		SELECT COUNT(*)
		FROM EVAL_MANAGEMENT
	</select>
	
	<select id="LectureEvalOpenList2" resultMap="lectureEvaluationResultSet">
		SELECT *
		FROM EVAL_MANAGEMENT
	</select>
	
	
</mapper>